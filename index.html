<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéØ Battle Timer - Last War</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: ‚ÄòSegoe UI‚Äô, Arial, sans-serif;
background: linear-gradient(135deg, #0b1020 0%, #1a2744 100%);
color: #ffffff;
padding: 10px;
min-height: 100vh;
}

.container {
max-width: 900px;
margin: 0 auto;
padding: 15px;
}

.header {
text-align: center;
padding: 20px;
background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
border-radius: 15px;
margin-bottom: 20px;
box-shadow: 0 5px 20px rgba(255, 68, 68, 0.4);
}

.header h1 {
font-size: 2em;
margin-bottom: 5px;
text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

/* SETUP PANEL */
.setup-panel {
background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
color: #1a1a2e;
border-radius: 15px;
padding: 25px;
margin-bottom: 20px;
box-shadow: 0 5px 20px rgba(255, 204, 0, 0.4);
}

.setup-panel h3 {
font-size: 1.5em;
margin-bottom: 20px;
text-align: center;
}

/* MODE SELECTOR */
.mode-selector {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-bottom: 30px;
}

.mode-btn {
background: rgba(255,255,255,0.9);
border: 3px solid transparent;
padding: 30px 20px;
border-radius: 12px;
font-size: 1.3em;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
text-align: center;
}

.mode-btn:hover {
transform: translateY(-3px);
box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.mode-btn.selected {
background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%);
color: white;
border-color: #fff;
transform: scale(1.05);
}

.mode-icon {
font-size: 2.5em;
display: block;
margin-bottom: 10px;
}

/* TIMEZONE GRID */
.timezone-instructions {
background: rgba(0,0,0,0.2);
padding: 15px;
border-radius: 10px;
margin-bottom: 20px;
font-size: 1.1em;
text-align: center;
}

.timezone-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
gap: 12px;
margin-bottom: 20px;
}

.timezone-btn {
background: rgba(255,255,255,0.9);
color: #1a1a2e;
border: 3px solid transparent;
padding: 15px 10px;
border-radius: 12px;
font-size: 1em;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
text-align: center;
}

.timezone-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.timezone-btn.selected {
background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%);
color: white;
border-color: #fff;
transform: scale(1.05);
}

.timezone-emoji {
font-size: 1.8em;
display: block;
margin-bottom: 5px;
}

.timezone-name {
font-size: 0.9em;
display: block;
margin-bottom: 3px;
}

.timezone-offset {
font-size: 0.75em;
opacity: 0.8;
display: block;
}

.confirm-btn {
background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%);
color: white;
border: none;
padding: 20px 40px;
border-radius: 12px;
font-size: 1.4em;
font-weight: bold;
cursor: pointer;
width: 100%;
transition: all 0.3s ease;
}

.confirm-btn:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(78, 205, 196, 0.5);
}

.confirm-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* CLOCKS */
.clocks-display {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-bottom: 20px;
}

.clock-box {
background: rgba(255,255,255,0.05);
border-radius: 10px;
padding: 20px;
text-align: center;
border: 2px solid rgba(255,255,255,0.1);
}

.clock-box.server {
border-color: #ff4444;
box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
}

.clock-label {
font-size: 0.9em;
opacity: 0.8;
margin-bottom: 8px;
text-transform: uppercase;
letter-spacing: 1px;
}

.clock-time {
font-size: 2.2em;
font-weight: bold;
font-family: ‚ÄòCourier New‚Äô, monospace;
color: #ffcc00;
}

.clock-box.server .clock-time {
color: #ff4444;
}

/* TRAINING MODE CONTROLS */
.training-controls {
background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
border-radius: 15px;
padding: 20px;
margin-bottom: 20px;
text-align: center;
}

.training-title {
font-size: 1.3em;
margin-bottom: 15px;
text-transform: uppercase;
letter-spacing: 2px;
}

.training-buttons {
display: flex;
gap: 10px;
justify-content: center;
flex-wrap: wrap;
}

.training-btn {
background: rgba(255,255,255,0.2);
border: 2px solid rgba(255,255,255,0.5);
color: white;
padding: 15px 25px;
border-radius: 10px;
font-size: 1.1em;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 8px;
}

.training-btn:hover {
background: rgba(255,255,255,0.3);
transform: translateY(-2px);
}

.training-btn:active {
transform: scale(0.95);
}

.training-btn.prev {
background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
}

.training-btn.next {
background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
}

.training-btn.reset {
background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
}

/* COUNTDOWN */
.countdown-box {
background: linear-gradient(135deg, #2d3561 0%, #1a2140 100%);
border: 3px solid #ffcc00;
border-radius: 15px;
padding: 25px;
margin-bottom: 20px;
text-align: center;
box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
}

.countdown-label {
font-size: 1.1em;
opacity: 0.8;
margin-bottom: 10px;
text-transform: uppercase;
letter-spacing: 2px;
}

.countdown-display {
font-size: 3.5em;
font-weight: bold;
font-family: ‚ÄòCourier New‚Äô, monospace;
color: #ffcc00;
text-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
letter-spacing: 3px;
}

.countdown-display.urgent {
color: #ff4444;
animation: pulse 1s infinite;
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

/* FASE */
.phase-box {
border: 3px solid #ff4444;
border-radius: 15px;
padding: 25px;
margin-bottom: 20px;
background: linear-gradient(135deg, #1a2140 0%, #0f1628 100%);
box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}

.phase-box.phase-0 { border-color: #ffcc00; }
.phase-box.phase-1 { border-color: #ff4444; }
.phase-box.phase-2 { border-color: #4ecdc4; }
.phase-box.phase-3 { border-color: #fd79a8; }
.phase-box.phase-4 { border-color: #a29bfe; }
.phase-box.phase-5 { border-color: #4ecdc4; }

.phase-box h2 {
font-size: 1.8em;
color: #ffcc00;
margin-bottom: 15px;
text-transform: uppercase;
}

.phase-message {
font-size: 1.2em;
line-height: 1.6;
white-space: pre-line;
}

/* CANNONE */
.cannon-display {
font-size: 4em;
font-weight: bold;
text-align: center;
padding: 30px;
border-radius: 15px;
margin-bottom: 20px;
box-shadow: 0 5px 20px rgba(0,0,0,0.5);
transition: all 0.3s ease;
}

.cannon-display.prep { background: linear-gradient(135deg, #ffcc00 0%, #f6b93b 100%); color: #1a1a2e; }
.cannon-display.nord { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: #fff; }
.cannon-display.est { background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%); color: #fff; }
.cannon-display.sud { background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); color: #fff; }
.cannon-display.ovest { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); color: #fff; }
.cannon-display.finale { background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%); color: #fff; }

/* MAPPA */
.battlefield-mini {
position: relative;
width: 100%;
max-width: 400px;
height: 400px;
margin: 20px auto;
background:
radial-gradient(circle at center, rgba(78,205,196,0.15) 0%, transparent 60%),
linear-gradient(135deg, #2d4a3e 0%, #1a2f23 100%);
border: 3px solid #ff6b6b;
border-radius: 15px;
box-shadow: inset 0 0 30px rgba(0,0,0,0.6), 0 0 20px rgba(255,107,107,0.4);
}

.mini-cannon {
position: absolute;
width: 80px;
height: 80px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 2em;
font-weight: bold;
border: 3px solid #fff;
transition: all 0.3s ease;
opacity: 0.5;
}

.mini-cannon.active {
opacity: 1;
transform: scale(1.2);
box-shadow: 0 0 30px rgba(255,204,0,1);
border-color: #ffcc00;
animation: glow 1.5s infinite;
}

@keyframes glow {
0%, 100% { box-shadow: 0 0 30px rgba(255,204,0,1); }
50% { box-shadow: 0 0 50px rgba(255,204,0,1); }
}

.mini-cannon.completed {
opacity: 1;
border-color: #4ecdc4;
}

.mini-cannon.completed::after {
content: ‚Äò‚úì‚Äô;
position: absolute;
top: -10px;
right: -10px;
background: #4ecdc4;
width: 30px;
height: 30px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.7em;
border: 2px solid #fff;
}

#mini1 { top: 30px; left: 30px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); }
#mini2 { top: 30px; right: 30px; background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%); }
#mini3 { bottom: 30px; right: 30px; background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); }
#mini4 { bottom: 30px; left: 30px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); }

.mini-capitol {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 60px;
height: 60px;
background: linear-gradient(135deg, #ffd93d 0%, #f6b93b 100%);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 2em;
border: 3px solid #fff;
box-shadow: 0 0 20px rgba(255,217,61,0.8);
}

/* PROGRESS */
.progress-container {
width: 100%;
height: 30px;
background: rgba(255,255,255,0.1);
border-radius: 15px;
overflow: hidden;
margin-bottom: 20px;
}

.progress-bar {
height: 100%;
background: linear-gradient(90deg, #ffcc00 0%, #ff4444 100%);
transition: width 1s linear;
display: flex;
align-items: center;
justify-content: flex-end;
padding-right: 10px;
font-weight: bold;
font-size: 0.9em;
}

/* NOTIFICHE */
.notification-box {
text-align: center;
padding: 15px;
background: rgba(255,255,255,0.05);
border-radius: 10px;
margin-bottom: 20px;
}

.enable-notifications-btn {
background: linear-gradient(135deg, #4ecdc4 0%, #44a3a0 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 10px;
font-size: 1.1em;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}

.enable-notifications-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 20px rgba(78, 205, 196, 0.5);
}

.notification-enabled {
color: #4ecdc4;
font-weight: bold;
}

/* HIDDEN */
.hidden {
display: none !important;
}

/* FOOTER */
.footer {
text-align: center;
opacity: 0.6;
font-size: 0.9em;
margin-top: 30px;
padding: 20px;
}

/* RESPONSIVE */
@media (max-width: 768px) {
.header h1 { font-size: 1.5em; }
.mode-selector { grid-template-columns: 1fr; }
.timezone-grid { grid-template-columns: 1fr 1fr; }
.clocks-display { grid-template-columns: 1fr; }
.countdown-display { font-size: 2.5em; }
.cannon-display { font-size: 3em; padding: 20px; }
.battlefield-mini { width: 300px; height: 300px; }
.mini-cannon { width: 60px; height: 60px; font-size: 1.5em; }
#mini1, #mini2 { top: 20px; }
#mini1, #mini4 { left: 20px; }
#mini2, #mini3 { right: 20px; }
#mini3, #mini4 { bottom: 20px; }
.mini-capitol { width: 50px; height: 50px; font-size: 1.5em; }
.training-buttons { flex-direction: column; }
.training-btn { width: 100%; justify-content: center; }
}
</style>

</head>
<body>
<div class="container">
  <!-- HEADER -->
  <div class="header">
    <h1>üéØ BATTLE COMMAND TIMER</h1>
    <div class="subtitle">Last War: Survival - Server vs Server</div>
  </div>

  <!-- SETUP PANEL -->

  <div class="setup-panel" id="setupPanel">
    <h3>‚öôÔ∏è CONFIGURAZIONE TIMER</h3>

```
<!-- MODE SELECTOR -->
<div class="mode-selector">
  <button class="mode-btn" data-mode="live">
    <span class="mode-icon">‚öîÔ∏è</span>
    MODALIT√Ä LIVE
  </button>
  <button class="mode-btn" data-mode="training">
    <span class="mode-icon">üéì</span>
    ESERCITAZIONE
  </button>
</div>

<!-- TIMEZONE SELECTOR -->
<div class="timezone-instructions">
  <strong>üåç Dove ti trovi?</strong><br>
  Seleziona la tua zona geografica
</div>

<div class="timezone-grid">
  <button class="timezone-btn" data-offset="0" data-name="Portogallo">
    <span class="timezone-emoji">üáµüáπ</span>
    <span class="timezone-name">Portogallo</span>
    <span class="timezone-offset">UTC+0</span>
  </button>
  
  <button class="timezone-btn" data-offset="0" data-name="UK">
    <span class="timezone-emoji">üá¨üáß</span>
    <span class="timezone-name">UK / Irlanda</span>
    <span class="timezone-offset">UTC+0</span>
  </button>
  
  <button class="timezone-btn" data-offset="+1" data-name="Europa Centrale">
    <span class="timezone-emoji">üáÆüáπüá®üá≠üá©üá™</span>
    <span class="timezone-name">Europa Centrale</span>
    <span class="timezone-offset">UTC+1 (CET)</span>
  </button>
  
  <button class="timezone-btn" data-offset="+2" data-name="Europa Est">
    <span class="timezone-emoji">üá¨üá∑üá∑üá¥üá´üáÆ</span>
    <span class="timezone-name">Europa Orientale</span>
    <span class="timezone-offset">UTC+2</span>
  </button>
  
  <button class="timezone-btn" data-offset="+3" data-name="Turchia">
    <span class="timezone-emoji">üáπüá∑üá∑üá∫</span>
    <span class="timezone-name">Turchia / Russia</span>
    <span class="timezone-offset">UTC+3</span>
  </button>
</div>

<button class="confirm-btn" id="confirmBtn" disabled>
  ‚úÖ AVVIA TIMER
</button>
```

  </div>

  <!-- MAIN CONTENT -->

  <div id="mainContent" class="hidden">
    <!-- OROLOGI -->
    <div class="clocks-display">
      <div class="clock-box">
        <div class="clock-label">üïê Il Tuo Orario</div>
        <div class="clock-time" id="localTime">--:--:--</div>
      </div>
      <div class="clock-box server">
        <div class="clock-label">üéÆ Orario Server</div>
        <div class="clock-time" id="serverTime">12:--:--</div>
      </div>
    </div>

```
<!-- TRAINING CONTROLS (solo modalit√† esercitazione) -->
<div class="training-controls hidden" id="trainingControls">
  <div class="training-title">üéì CONTROLLI ESERCITAZIONE</div>
  <div class="training-buttons">
    <button class="training-btn prev" id="prevPhaseBtn">
      ‚¨ÖÔ∏è FASE PRECEDENTE
    </button>
    <button class="training-btn reset" id="resetTrainingBtn">
      üîÑ RESET
    </button>
    <button class="training-btn next" id="nextPhaseBtn">
      FASE SUCCESSIVA ‚û°Ô∏è
    </button>
  </div>
</div>

<!-- NOTIFICHE -->
<div class="notification-box" id="notificationBox">
  <button class="enable-notifications-btn" id="enableNotifications">
    üîî Attiva Notifiche
  </button>
</div>

<!-- COUNTDOWN -->
<div class="countdown-box">
  <div class="countdown-label" id="countdownLabel">‚è≥ INIZIO GUERRA TRA:</div>
  <div class="countdown-display" id="countdownDisplay">--:--:--</div>
</div>

<!-- PROGRESS -->
<div class="progress-container">
  <div class="progress-bar" id="progressBar">0%</div>
</div>

<!-- FASE -->
<div class="phase-box" id="phaseBox">
  <h2 id="phaseTitle">In attesa...</h2>
  <p class="phase-message" id="phaseMessage">Seleziona modalit√† e fuso orario per iniziare.</p>
</div>

<!-- CANNONE -->
<div class="cannon-display prep" id="cannonDisplay">‚Äî</div>

<!-- MAPPA -->
<div class="battlefield-mini">
  <div class="mini-capitol">üèõÔ∏è</div>
  <div class="mini-cannon" id="mini1">1</div>
  <div class="mini-cannon" id="mini2">2</div>
  <div class="mini-cannon" id="mini3">3</div>
  <div class="mini-cannon" id="mini4">4</div>
</div>

<!-- FOOTER -->
<div class="footer">
  <div>Timer sincronizzato con Server Time (sempre 12:00)</div>
  <div style="margin-top: 10px; color: #4ecdc4;" id="timezoneInfo"></div>
</div>
```

  </div>
</div>

<script>
/***********************
 * CONFIGURAZIONE
 ************************/
const WAR_START_SERVER_HOUR = 12;
const WAR_START_SERVER_MIN = 0;

// CET √® UTC+1
// Server √® sempre 12:00 quando in CET sono le 15:00
// Quindi: quando server = 12:00, CET = 15:00
// Differenza: +3 ore

/***********************
 * FASI
 ************************/
const PHASES = [
  {
    id: 0,
    from: -5,
    to: 0,
    cannon: "PREPARAZIONE",
    cannonClass: "prep",
    title: "FASE 0 ‚Äì PREPARAZIONE",
    message: `üéØ Preparazione generale
üó°Ô∏è Ariete: Pronti vicino a NORD
üõ°Ô∏è Muro: In posizione di attesa
üî® Martello: Inizia posizionamento

‚ö†Ô∏è NESSUN ATTACCO prima delle 12:00 server!`
  },
  {
    id: 1,
    from: 0,
    to: 5,
    cannon: "1 NORD",
    cannonClass: "nord",
    title: "FASE 1 ‚Äì CANNONE NORD",
    message: `üéØ ATTACCARE CANNONE NORD!

üó°Ô∏è Ariete (TUTTE alleanze): Rally 5-8
üõ°Ô∏è Muro NGC-NS1: Prepararsi
üî® Martello: Scout spam

üìç Non assegnati: T1 CAMPIDOGLIO`
  },
  {
    id: 2,
    from: 5,
    to: 10,
    cannon: "2 EST",
    cannonClass: "est",
    title: "FASE 2 ‚Äì CANNONE EST",
    message: `üéØ ATTACCARE CANNONE EST!

üó°Ô∏è Ariete: Nord ‚Üí Est
üõ°Ô∏è Muro UP4-GLDY: Prepararsi
üõ°Ô∏è NGC-NS1: Difesa Nord

üìç Non assegnati: T1 CAMPIDOGLIO`
  },
  {
    id: 3,
    from: 10,
    to: 15,
    cannon: "3 SUD",
    cannonClass: "sud",
    title: "FASE 3 ‚Äì CANNONE SUD",
    message: `üéØ ATTACCARE CANNONE SUD!

üó°Ô∏è Ariete: Est ‚Üí Sud
üõ°Ô∏è Muro DJN-FmLy-BwF: Prepararsi
‚ö†Ô∏è Possibile resistenza!

üìç Non assegnati: T1 CAMPIDOGLIO`
  },
  {
    id: 4,
    from: 15,
    to: 20,
    cannon: "4 OVEST",
    cannonClass: "ovest",
    title: "FASE 4 ‚Äì CANNONE OVEST",
    message: `üéØ ATTACCARE CANNONE OVEST!

üó°Ô∏è Ariete: Sud ‚Üí Ovest (ULTIMO!)
üõ°Ô∏è Muro VNEM-LdKy: Prepararsi
üèÜ Dopo: Ariete torna alle aree!

üìç Non assegnati: T1 CAMPIDOGLIO`
  },
  {
    id: 5,
    from: 20,
    to: 30,
    cannon: "DIFESA",
    cannonClass: "finale",
    title: "FASE 5 ‚Äì DIFESA TOTALE",
    message: `üõ°Ô∏è TUTTI I CANNONI CONTROLLATI!

üó°Ô∏è Ariete: Rinforzi aree
üõ°Ô∏è Muro: Difesa MASSIMA
üî® Martello: INTENSIFICA
üèõÔ∏è Campidoglio: Priorit√†

üèÜ Tenere fino a 30 min!`
  }
];

/***********************
 * VARIABILI GLOBALI
 ************************/
let selectedMode = null; // 'live' o 'training'
let userTimezoneOffset = null; // 0, +1, +2, +3
let timerStarted = false;
let notificationsEnabled = false;
let lastPhaseId = -1;
let audioContext = null;

// Training mode
let trainingPhaseIndex = 0;

/***********************
 * SETUP
 ************************/
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    selectedMode = this.dataset.mode;
    checkCanConfirm();
  });
});

document.querySelectorAll('.timezone-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.timezone-btn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    userTimezoneOffset = parseInt(this.dataset.offset);
    checkCanConfirm();
  });
});

function checkCanConfirm() {
  const can = selectedMode !== null && userTimezoneOffset !== null;
  document.getElementById('confirmBtn').disabled = !can;
}

document.getElementById('confirmBtn').addEventListener('click', function() {
  localStorage.setItem('selectedMode', selectedMode);
  localStorage.setItem('userTimezoneOffset', userTimezoneOffset);
  
  document.getElementById('setupPanel').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  
  if (selectedMode === 'training') {
    document.getElementById('trainingControls').classList.remove('hidden');
    document.getElementById('countdownLabel').textContent = 'üéì MODALIT√Ä ESERCITAZIONE';
    document.getElementById('countdownDisplay').textContent = 'MANUALE';
  }
  
  const zoneName = document.querySelector('.timezone-btn.selected').dataset.name;
  document.getElementById('timezoneInfo').textContent = 
    `üìç ${zoneName} | Modalit√†: ${selectedMode === 'live' ? 'LIVE ‚öîÔ∏è' : 'ESERCITAZIONE üéì'}`;
  
  timerStarted = true;
  update();
});

// Training controls
document.getElementById('prevPhaseBtn').addEventListener('click', () => {
  if (trainingPhaseIndex > 0) {
    trainingPhaseIndex--;
    updateTrainingPhase();
  }
});

document.getElementById('nextPhaseBtn').addEventListener('click', () => {
  if (trainingPhaseIndex < PHASES.length - 1) {
    trainingPhaseIndex++;
    updateTrainingPhase();
  }
});

document.getElementById('resetTrainingBtn').addEventListener('click', () => {
  trainingPhaseIndex = 0;
  updateTrainingPhase();
});

/***********************
 * CALCOLO ORARI
 ************************/
function getServerTime() {
  // L'orario del server √® SEMPRE fisso
  // Calcoliamo quanto tempo √® passato dall'inizio della giornata locale
  // e lo applichiamo partendo da 12:00:00
  
  const now = new Date();
  const localSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
  
  // Differenza tra timezone utente e CET
  // CET = UTC+1, quindi se l'utente √® a UTC+0 (Portogallo), differenza = -1
  // Se utente √® a UTC+3 (Turchia), differenza = +2
  const cetOffset = 1; // CET = UTC+1
  const hoursFromCET = userTimezoneOffset - cetOffset;
  
  // Quando in CET sono le 15:00, sul server sono le 12:00
  // Quindi dobbiamo sottrarre 3 ore dal CET per avere il server time
  const cetSeconds = localSeconds - (hoursFromCET * 3600);
  const serverSeconds = cetSeconds - (3 * 3600);
  
  // Normalizziamo in 24h
  const normalizedSeconds = ((serverSeconds % 86400) + 86400) % 86400;
  
  const hours = Math.floor(normalizedSeconds / 3600);
  const mins = Math.floor((normalizedSeconds % 3600) / 60);
  const secs = normalizedSeconds % 60;
  
  const serverTime = new Date();
  serverTime.setHours(hours, mins, secs, 0);
  
  return serverTime;
}

function getWarStartTime() {
  // La guerra inizia alle 12:00 server time
  // Dobbiamo calcolare quando sono le 12:00 server nell'orario locale
  
  const now = new Date();
  const warStart = new Date(now);
  
  // Parte da 12:00
  warStart.setHours(WAR_START_SERVER_HOUR, WAR_START_SERVER_MIN, 0, 0);
  
  // Aggiungi 3 ore (server ‚Üí CET)
  // Poi aggiungi/sottrai per arrivare al fuso dell'utente
  const cetOffset = 1;
  const hoursToAdd = 3 + (userTimezoneOffset - cetOffset);
  
  warStart.setHours(warStart.getHours() + hoursToAdd);
  
  return warStart;
}

function getActivePhase() {
  if (selectedMode === 'training') {
    return PHASES[trainingPhaseIndex];
  }
  
  const now = new Date();
  const warStart = getWarStartTime();
  const diffMin = (now - warStart) / 60000;
  
  return PHASES.find(p => diffMin >= p.from && diffMin < p.to) || null;
}

function getPhaseProgress() {
  if (selectedMode === 'training') return 100;
  
  const phase = getActivePhase();
  if (!phase) return 0;
  
  const now = new Date();
  const warStart = getWarStartTime();
  const diffMin = (now - warStart) / 60000;
  
  const elapsed = diffMin - phase.from;
  const duration = phase.to - phase.from;
  
  return Math.min(100, Math.max(0, (elapsed / duration) * 100));
}

/***********************
 * TRAINING MODE
 ************************/
function updateTrainingPhase() {
  updatePhaseUI();
  showNotification(PHASES[trainingPhaseIndex].title, "Fase esercitazione");
}

/***********************
 * NOTIFICHE
 ************************/
function requestNotificationPermission() {
  if (!("Notification" in window)) {
    alert("Questo browser non supporta le notifiche");
    return;
  }
  
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      notificationsEnabled = true;
      document.getElementById('notificationBox').innerHTML = 
        '<div class="notification-enabled">‚úÖ Notifiche attive!</div>';
      showNotification("Notifiche attivate!", "Riceverai avvisi ad ogni cambio fase.");
    }
  });
}

function showNotification(title, body) {
  if (!notificationsEnabled || Notification.permission !== "granted") return;
  
  playSound();
  
  new Notification(title, {
    body: body,
    icon: 'üéØ',
    vibrate: [200, 100, 200]
  });
}

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playSound() {
  initAudio();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.frequency.value = 800;
  gain.gain.setValueAtTime(0.3, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  osc.start(audioContext.currentTime);
  osc.stop(audioContext.currentTime + 0.3);
}

/***********************
 * UPDATE UI
 ************************/
function updateClocks() {
  const now = new Date();
  const serverTime = getServerTime();
  
  document.getElementById('localTime').textContent = 
    now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  
  document.getElementById('serverTime').textContent = 
    serverTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function updateCountdown() {
  if (selectedMode === 'training') return;
  
  const now = new Date();
  const warStart = getWarStartTime();
  const diff = warStart - now;
  
  const label = document.getElementById("countdownLabel");
  const display = document.getElementById("countdownDisplay");
  
  if (diff > 0) {
    const hours = Math.floor(diff / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    
    label.textContent = "‚è≥ INIZIO GUERRA TRA:";
    display.textContent = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    display.classList.remove('urgent');
    
    if (diff < 60000) display.classList.add('urgent');
  } else if (diff > -30 * 60000) {
    const elapsed = Math.abs(diff);
    const mins = Math.floor(elapsed / 60000);
    const secs = Math.floor((elapsed % 60000) / 1000);
    
    label.textContent = "‚öîÔ∏è GUERRA IN CORSO:";
    display.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    display.classList.remove('urgent');
  } else {
    label.textContent = "üèÜ GUERRA TERMINATA";
    display.textContent = "VITTORIA!";
    display.classList.remove('urgent');
  }
}

function updatePhaseUI() {
  const phase = getActivePhase();
  if (!phase) return;
  
  if (selectedMode === 'live' && phase.id !== lastPhaseId && lastPhaseId !== -1) {
    showNotification(phase.title, phase.message.split('\n')[0]);
  }
  lastPhaseId = phase.id;
  
  const phaseBox = document.getElementById("phaseBox");
  phaseBox.className = `phase-box phase-${phase.id}`;
  document.getElementById("phaseTitle").textContent = phase.title;
  document.getElementById("phaseMessage").textContent = phase.message;
  
  const cannonDisplay = document.getElementById("cannonDisplay");
  cannonDisplay.textContent = phase.cannon;
  cannonDisplay.className = `cannon-display ${phase.cannonClass}`;
  
  document.querySelectorAll('.mini-cannon').forEach(c => {
    c.classList.remove('active', 'completed');
  });
  
  if (phase.id >= 1 && phase.id <= 4) {
    document.getElementById(`mini${phase.id}`).classList.add('active');
    for (let i = 1; i < phase.id; i++) {
      document.getElementById(`mini${i}`).classList.add('completed');
    }
  } else if (phase.id === 5) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`mini${i}`).classList.add('completed');
    }
  }
}

function updateProgressBar() {
  const progress = getPhaseProgress();
  const bar = document.getElementById("progressBar");
  bar.style.width = progress + '%';
  bar.textContent = Math.round(progress) + '%';
}

function update() {
  if (!timerStarted) return;
  updateClocks();
  updateCountdown();
  updatePhaseUI();
  updateProgressBar();
}

document.getElementById("enableNotifications").addEventListener("click", requestNotificationPermission);

setInterval(update, 1000);
console.log("‚úÖ Battle Timer caricato!");
</script>

</body>
</html>